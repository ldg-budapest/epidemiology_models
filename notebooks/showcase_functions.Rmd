---
title: "`r params$report_title`"
author: "`r params$report_author`"
date: "`r Sys.Date()`"
output: html_document
params:
  report_title: "Showcase functionality of scripts in repo"
  report_author: "Tamas Szabo"
knit: "(function(inputFile, encoding) { rmarkdown::render(inputFile, encoding = encoding, output_file = file.path(dirname(dirname(inputFile)),'reports',paste(substr(basename(inputFile),1,nchar(basename(inputFile))-4),'_',Sys.Date(),'.html',sep=''))) })"
---

# Setup

## Library imports

```{r include=FALSE, warning=FALSE, message=FALSE}
library(tidyr)
library(dplyr)
```

## Eaxample dataset

```{r}
example_dataset <- "../example_data/crc_lung_mortality.csv" %>%
  read.csv(check.names=FALSE) %>%
  pivot_longer(
    one_of("Colorectal (C18)", "Lung (C33-34)"),
    names_to = "Diagnosis", values_to = "N_cases"
  ) %>%
  mutate(
    Age = as.character(Age)
  )

# Commonly, numbers for both sexes merged are also present
example_dataset <- example_dataset %>%
  group_by(Age, Period, Diagnosis) %>%
  summarise(
    N_cases = sum(N_cases, na.rm=TRUE),
    Population = sum(Population, na.rm=TRUE)
  ) %>%
  ungroup() %>%
  mutate(
    Sex = "Total"
  ) %>%
  bind_rows(example_dataset)

# Adding the total age group to show it does not interfere with models
example_dataset <- example_dataset %>%
  group_by(Sex, Period, Diagnosis) %>%
  summarise(
    N_cases = sum(N_cases, na.rm=TRUE),
    Population = sum(Population, na.rm=TRUE)
  ) %>%
  ungroup() %>%
  mutate(
    Age = "Total"
  ) %>%
  bind_rows(example_dataset)

head(example_dataset)
```

```{r}
age_10_dataset <- example_dataset %>%
  filter(Age != "Total") %>%
  mutate(
    Age = as.numeric(Age),
    Age_c = cut(Age, seq(-1, 100, 10)),
    Age_d = gsub(",.*", "", Age_c),
    Age_d = gsub("\\(", "", Age_d),
    Age_c = gsub(".*,", "", Age_c),
    Age_c = gsub("\\]", "", Age_c),
    Age = paste(as.numeric(Age_d)+1, "-", Age_c, sep=""),
    Age = ifelse(Age == "90-99", "90-x", Age)
  ) %>%
  group_by(Age, Sex, Period, Diagnosis) %>%
  summarise(
    Population = sum(Population, na.rm=TRUE),
    N_cases = sum(N_cases, na.rm=TRUE)
  ) %>%
  ungroup()

# Re-adding the total age group
age_10_dataset <- age_10_dataset %>%
  group_by(Sex, Period, Diagnosis) %>%
  summarise(
    N_cases = sum(N_cases, na.rm=TRUE),
    Population = sum(Population, na.rm=TRUE)
  ) %>%
  ungroup() %>%
  mutate(
    Age = "Total"
  ) %>%
  bind_rows(age_10_dataset)

head(age_10_dataset)
```

# Functionality

## Standardized rates

```{r}
source("../scripts/european_standard_population.R")
```

By default, rate is standardized as the number of cases in 100,000 persons.

```{r}
standardized_table <- age_10_dataset %>%
  calculate_standardized_rate(extra_grouping_cols="Diagnosis")

standardized_table %>%
  filter(Period == "2021", Sex == "Total") %>%
  select(Age, name=Diagnosis, value=Std_rate) %>%
  mutate(
    value = round(value, 2)
  ) %>%
  pivot_wider() %>%
  tail(8)
```

The same function can be used to calculate direct standardized rates

```{r}
standardized_table <- age_10_dataset %>%
  calculate_standardized_rate(
    extra_grouping_cols="Diagnosis", standard_population="esp2013"
  ) %>%
  select(Period, Sex, Diagnosis, value=Std_rate) %>%
  mutate(
    value = round(value, 2)
  ) %>%
  pivot_wider(names_from=c("Diagnosis", "Sex")) %>%
  arrange(desc(Period)) %>%
  head()

head(standardized_table)
```

The 10-year granularity should not differ much from single-year granularity:

```{r}
standardized_table <- example_dataset %>%
  # Age needs to be formatted a bit
  mutate(
    Age = paste(Age, "-", Age, sep=""),
    Age = ifelse(Age == "90-90", "90-x", Age)
  ) %>%
  calculate_standardized_rate(
    extra_grouping_cols="Diagnosis", standard_population="esp2013"
  ) %>%
  select(Period, Sex, Diagnosis, value=Std_rate) %>%
  mutate(
    value = round(value, 2)
  ) %>%
  pivot_wider(names_from=c("Diagnosis", "Sex")) %>%
  arrange(desc(Period)) %>%
  head()

head(standardized_table)
```

A convenience option is to standardize to one of the years also present in the data by simply supplying that year as a parameter.

```{r}
standardized_table <- age_10_dataset %>%
  calculate_standardized_rate(
    extra_grouping_cols="Diagnosis", standard_population="2011"
  ) %>%
  select(Period, Sex, Diagnosis, value=Std_rate) %>%
  mutate(
    value = round(value, 2)
  ) %>%
  pivot_wider(names_from=c("Diagnosis", "Sex")) %>%
  arrange(desc(Period)) %>%
  head()

head(standardized_table)
```

Please note, however that DSRs are applied to the total population and not to separate age groups.

## Virtual patient numbers

## Average yearly change

## Expected case numbers

# End